
 <button type="submit" id="cPostBtn-${itemId}" disabled='true'>Post Comment</button>
            </form>
          </bdo>
        </div>
      `;
      newDiv.className = 'crip';
      document.getElementById("com").appendChild(newDiv);

      // Hide name input if user is logged in
      
               if (currentUserName) {
          
          const nameInputField = newDiv.querySelector(`#commenterName-${itemId}`);
          const commentInputField = newDiv.querySelector(`#commentText-${itemId}`);
          
          if (nameInputField) nameInputField.parentElement.style.display = 'none';
          if (commentInputField){ commentInputField.disabled=false;
                                commentInputField.placeholder="Post your comment";
                                }
        }

      // Click tracking
      newDiv.addEventListener('click', (event) => {
        if (event.target.closest('.comment-section')) return;
        const clickedItems = JSON.parse(localStorage.getItem('clickedItems') || '[]');
        if (clickedItems.includes(itemId)) return;

        const itemRef = doc(db, "ginidev", itemId);
        updateDoc(itemRef, { clicks: increment(1) })
          .then(() => {
            clickedItems.push(itemId);
            localStorage.setItem('clickedItems', JSON.stringify(clickedItems));
          })
          .catch(console.error);
      });

      // Live click and vote updates
      const itemRef = doc(db, "ginidev", itemId);
      onSnapshot(itemRef, (docUpdate) => {
        const updatedData = docUpdate.data();
        document.getElementById(`click-count-${itemId}`).textContent = `${updatedData.clicks || 0} VIEWS`;
        document.getElementById(`upvotes-${itemId}`).textContent = updatedData.upvotes || 0;
        document.getElementById(`downvotes-${itemId}`).textContent = updatedData.downvotes || 0;
      });

      // Comments
      const commentsQuery = query(collection(db, "comments"), orderBy("createdAt", "asc"));
      onSnapshot(commentsQuery, (commentsSnapshot) => {
        const itemComments = [];
        commentsSnapshot.forEach((commentDoc) => {
          if (commentDoc.data().itemId === itemId) {
            itemComments.push(commentDoc.data());
          }
        });
        displayComments(itemId, itemComments);
      });

      const commentForm = document.getElementById(`comment-form-${itemId}`);
      if (commentForm) {
        commentForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const commentText = commentForm.querySelector('textarea').value.replace(/-i\(([^\{\}\[\]\(\)\|]*)\s?\|([^\(\)]*)\)/gi,"+$+img src='$1' alt=$2//:-").replace(/-v\(([^\{\}\[\]\(\)\|]*)\s?\|([^\(\)]*)\)/gi,'+$+video autoplay muted loop src="$1" id=valvideo-$2/:- +$+/video/:-').replace(/\*\*(.*?)\*\*/g, "+$+b/:-$1+$+/b/:-").replace(/```([\s\S]*?)```/g, " +$+pre/:- +$+code/:-$1+$+/code/:- +$+/pre/:-").replace(/`(.*?)`/g, "+$+code/:-+$+mark style='background:#ddd;border-radius:2px;'/:-$1+$+/mark/:-+$+/code/:-").replace(/\</g, '&lt;').replace(/\>/g, '&gt;').replace(/\/\:\-/gi, '>').replace(/\+\$\+/gi, '<').replace(/\n/g, '<br>').replace(/\s{2}/g,'&ensp;');
          let commenterName = currentUserName || commentForm.querySelector(`#commenterName-${itemId}`).value.trim() || 'Anonymous';

          if (commentText) {
const inboxEm=commentForm.name||"nomail@eku.org";
          
              const inboxMsg = `<a href="/search?q=${encodeURIComponent(commenterName)}"><b>${commenterName}</b></a> commented on your post: <a href="/search?q=${encodeURIComponent(commentForm.title)}"><b>${commentForm.title}</b></a> <br>`;

            try {
        await addDoc(collection(db, "inbox"), {
            type: "Post interaction/comments",
            body: inboxMsg,
            userEm: inboxEm,
            createdAt: new Date(),
           
        });
        
    } catch (err) {
        console.error("Failed to send message:", err);
        
    }
addDoc(commentsCollection, {
              itemId,
              text: commentText,
              commenterName,
              createdAt: new Date()
            }).then(() => {
              commentForm.querySelector('textarea').value = '';
              const nameInput = commentForm.querySelector(`#commenterName-${itemId}`);
              if (nameInput) nameInput.value = '';
            }).catch(console.error);
          }
        });
      }

      // Voting
      const upvoteBtn = newDiv.querySelector(`.upvote-btn[data-id="${itemId}"]`);
      const downvoteBtn = newDiv.querySelector(`.downvote-btn[data-id="${itemId}"]`);
      const votedItems = JSON.parse(localStorage.getItem('votedItems') || '{}');

      if (votedItems[itemId]) {
        upvoteBtn.disabled = votedItems[itemId] === 'up';
        downvoteBtn.disabled = votedItems[itemId] === 'down';
      }

      upvoteBtn.addEventListener("click", () => {
        if (votedItems[itemId]) return;
        updateDoc(itemRef, { upvotes: increment(1) }).then(() => {
          votedItems[itemId] = 'up';
          localStorage.setItem('votedItems', JSON.stringify(votedItems));
          upvoteBtn.disabled = true;
          downvoteBtn.disabled = true;
        });
      });

      downvoteBtn.addEventListener("click", () => {
if(confirm("Are you sure you want to downvote this post?")){
        if (votedItems[itemId]) return;
const inboxEm=downvoteBtn.name||"nomail@eku.org";
          
              const inboxMsg = `Your post: <a href="/search?q=${encodeURIComponent(downvoteBtn.title)}"><b>${downvoteBtn.title}</b></a> <br> has received a downvote from another user. Please note that repeated violations may affect your account status. 
<a href="/terms/guidelines">Review our community guidelines</a> to ensure your content follows the rules.`;
  
try {
        await addDoc(collection(db, "inbox"), {
            type: "Posts Interactions/Downvotes",
    body: inboxMsg,
    userEm: inboxEm,
    createdAt: new Date()
        });
        alert("Your message will be delivered.");
        rForm.reset();
    } catch (err) {
        console.error("Failed to send message:", err);
        alert("Failed to send message. Please try again.");
    }
        updateDoc(itemRef, { downvotes: increment(1) }).then(() => {
          votedItems[itemId] = 'down';
          localStorage.setItem('votedItems', JSON.stringify(votedItems));
          upvoteBtn.disabled = true;
          downvoteBtn.disabled = true;
        });
}
      });

    });
  });
</script>


